---
import { fetchTestimonios } from '../../utils/testimonios';
import SchemaTestimonios from '../seo/SchemaTestimonios.astro';
import fotoEjemplo from '../../assets/images/contacto/esfera.webp';

// Obtener testimonios de trabajadores desde el CSV
const { trabajadores } = await fetchTestimonios();
const testimonios = trabajadores.length > 0 
  ? trabajadores.map(t => ({ texto: t.testimonio, nombre: t.nombre, foto: t.foto }))
  : [
      {
        texto: "Trabajar aquí es formar parte de una familia que valora el crecimiento y la creatividad.",
        nombre: "María González",
        foto: fotoEjemplo.src
      }
    ];
---

<!-- Schema.org Testimonios de trabajadores -->
<SchemaTestimonios 
  testimonios={trabajadores.map(t => ({ nombre: t.nombre, testimonio: t.testimonio, fecha: t.fecha }))} 
  tipo="trabajadores" 
/>
<section class="bg-carobra-light-bg py-20" aria-label="Testimonios del equipo">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="text-carobra-dark text-center mb-16 font-extrabold">
      El equipo que impulsa tu crecimiento
    </h2>
    
    <div class="testimonios-carousel-nosotros relative flex items-center gap-8">
      <!-- Prev Button -->
      <button 
        class="prev-btn-nosotros bg-carobra-primary hover:bg-carobra-dark text-white w-12 h-12 rounded-full flex items-center justify-center transition-colors flex-shrink-0"
        aria-label="Anterior"
      >
        ←
      </button>

      <!-- Testimonios -->
      <div class="flex-1">
        {testimonios.map((testimonio, index) => {
          const esLargo = testimonio.texto.length > 200;
          const textoCorto = esLargo ? testimonio.texto.substring(0, 200) + '...' : testimonio.texto;
          
          return (
            <article class={`testimonio-item-nosotros text-center ${index > 0 ? 'hidden' : ''}`} itemscope itemtype="https://schema.org/Review" data-testimonio-index={index}>
              {testimonio.foto && (
                <div class="mb-8 flex justify-center">
                  <img
                    src={testimonio.foto}
                    alt={`Foto de ${testimonio.nombre}, miembro del equipo Carobra`}
                    class="w-32 h-32 rounded-full object-cover border-4 border-carobra-light shadow-xl"
                    loading="lazy"
                  />
                </div>
              )}
              <blockquote class="text-carobra-dark paragraph-1 mb-6" itemprop="reviewBody">
                <span class="testimonio-texto-completo-nosotros hidden md:inline">"{testimonio.texto}"</span>
                <span class="testimonio-texto-corto-nosotros md:hidden">
                  <span class="texto-preview-nosotros">"{textoCorto}"</span>
                  <span class="texto-completo-nosotros hidden">"{testimonio.texto}"</span>
                </span>
                {esLargo && (
                  <button class="leer-mas-btn-nosotros md:hidden block mx-auto mt-2 text-carobra-primary hover:bg-carobra-dark font-medium text-sm transition-colors" data-index={index}>
                    Leer más
                  </button>
                )}
              </blockquote>
              <p class="text-carobra-primary font-semibold paragraph-2" itemprop="author" itemscope itemtype="https://schema.org/Person">
                <span itemprop="name">{testimonio.nombre}</span>
              </p>
              <div itemprop="reviewRating" itemscope itemtype="https://schema.org/Rating">
                <meta itemprop="ratingValue" content="5" />
                <meta itemprop="bestRating" content="5" />
              </div>
              <div itemprop="itemReviewed" itemscope itemtype="https://schema.org/Organization">
                <meta itemprop="name" content="Carobra" />
              </div>
            </article>
          );
        })}
      </div>

      <!-- Next Button -->
      <button 
        class="next-btn-nosotros bg-carobra-primary hover:bg-carobra-dark text-white w-12 h-12 rounded-full flex items-center justify-center transition-colors flex-shrink-0"
        aria-label="Siguiente"
      >
        →
      </button>
    </div>
  </div>
</section>

<script>
  // Botón "Leer más" para testimonios largos en mobile (Nosotros)
  document.querySelectorAll('.leer-mas-btn-nosotros').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const button = e.target as HTMLButtonElement;
      const article = button.closest('article');
      const textoCorto = article?.querySelector('.testimonio-texto-corto-nosotros');
      const preview = textoCorto?.querySelector('.texto-preview-nosotros');
      const completo = textoCorto?.querySelector('.texto-completo-nosotros');
      
      if (preview && completo) {
        const estaExpandido = completo.classList.contains('hidden');
        
        if (estaExpandido) {
          preview.classList.add('hidden');
          completo.classList.remove('hidden');
          button.textContent = 'Leer menos';
        } else {
          preview.classList.remove('hidden');
          completo.classList.add('hidden');
          button.textContent = 'Leer más';
        }
      }
    });
  });

  // Carrusel de testimonios en Nosotros
  let currentTestimonioNosotros = 0;
  const testimoniosNosotros = document.querySelectorAll('.testimonio-item-nosotros');
  const prevBtnNosotros = document.querySelector('.prev-btn-nosotros');
  const nextBtnNosotros = document.querySelector('.next-btn-nosotros');

  function showTestimonioNosotros(index: number) {
    testimoniosNosotros.forEach((item, i) => {
      if (i === index) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  if (prevBtnNosotros && nextBtnNosotros && testimoniosNosotros.length > 0) {
    prevBtnNosotros.addEventListener('click', () => {
      currentTestimonioNosotros = (currentTestimonioNosotros - 1 + testimoniosNosotros.length) % testimoniosNosotros.length;
      showTestimonioNosotros(currentTestimonioNosotros);
    });

    nextBtnNosotros.addEventListener('click', () => {
      currentTestimonioNosotros = (currentTestimonioNosotros + 1) % testimoniosNosotros.length;
      showTestimonioNosotros(currentTestimonioNosotros);
    });
  }
</script>
